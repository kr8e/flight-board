<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Flight Board - Scheduled & Live</title>
  <style>
    body { font-family: Arial; background:black; color:white; text-align:center; }
    h1 { margin-top:20px; }
    form { margin:20px; }
    input, button { padding:8px; margin:5px; font-size:16px; }
    table { margin:auto; border-collapse:collapse; width:90%; font-size:18px; }
    th, td { padding:10px; border-bottom:1px solid gray; }
    .green { background-color:green; color:white; }
    .yellow { background-color:gold; color:black; }
    .red { background-color:crimson; color:white; }
    .gray { background-color:gray; color:white; }
  </style>
</head>
<body>

<h1>Flight Board - Scheduled & Live</h1>

<form id="flightForm">
  <input type="text" id="flightNumber" placeholder="Flight Number (e.g., 100)" required>
  <input type="date" id="flightDate" required>
  <button type="submit">Add Flight</button>
</form>

<table>
  <thead>
    <tr>
      <th>Flight</th>
      <th>From</th>
      <th>Departs</th>
      <th>To</th>
      <th>Arrives</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody id="flightTable">
    <tr><td colspan="6">No flights added yet</td></tr>
  </tbody>
</table>

<script>
const API_KEY = "f01d8a46ee087e3c97ccf5c18515cee6";
let flights = JSON.parse(localStorage.getItem("flights")) || [];

const tableBody = document.getElementById("flightTable");

document.getElementById("flightForm").addEventListener("submit", e => {
  e.preventDefault();
  const flightNumber = document.getElementById("flightNumber").value.trim().toUpperCase();
  const flightDate = document.getElementById("flightDate").value;
  flights.push({ flightNumber, flightDate });
  localStorage.setItem("flights", JSON.stringify(flights));
  document.getElementById("flightForm").reset();
  fetchFlights();
});

async function fetchFlights() {
  tableBody.innerHTML = "";

  const now = Date.now();

  for (const flight of flights) {
    try {
      const url = `https://api.aviationstack.com/v1/flights?access_key=${API_KEY}&flight_number=${encodeURIComponent(flight.flightNumber)}&flight_date=${flight.flightDate}`;
      const res = await fetch(url);
      const data = await res.json();

      if (!data.data || data.data.length === 0) {
        tableBody.innerHTML += `<tr><td colspan="6">No data for ${flight.flightNumber} on ${flight.flightDate}</td></tr>`;
        continue;
      }

      const match = data.data[0]; // Should only return the correct date with parameter

      const depAirport = match.departure.airport || "";
      const depTime = match.departure.actual || match.departure.estimated || match.departure.scheduled || "";
      const arrAirport = match.arrival.airport || "";
      const arrTime = match.arrival.actual || match.arrival.estimated || match.arrival.scheduled || "";
      const statusRaw = match.flight_status || "unknown";

      // Remove flights >30 min after landing
      const landedTime = match.arrival.actual ? new Date(match.arrival.actual) : null;
      if (statusRaw === "landed" && landedTime) {
        const diffMin = (now - landedTime.getTime()) / 60000;
        if (diffMin > 30) continue;
      }

      let statusClass = "";
      if (statusRaw === "scheduled" || statusRaw === "active") statusClass = "green";
      else if (statusRaw === "delayed") statusClass = "yellow";
      else if (statusRaw === "cancelled") statusClass = "red";
      else if (statusRaw === "landed") statusClass = "gray";

      tableBody.innerHTML += `
        <tr class="${statusClass}">
          <td>${match.flight.iata || match.flight.number}</td>
          <td>${depAirport}</td>
          <td>${formatTime(depTime)}</td>
          <td>${arrAirport}</td>
          <td>${formatTime(arrTime)}</td>
          <td>${statusRaw.toUpperCase()}</td>
        </tr>
      `;
    } catch (err) {
      tableBody.innerHTML += `<tr><td colspan="6">Error loading ${flight.flightNumber}</td></tr>`;
      console.error(err);
    }
  }
}

function formatTime(dateString) {
  if (!dateString) return "";
  const d = new Date(dateString);
  if (isNaN(d)) return "";
  return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
}

fetchFlights();
setInterval(fetchFlights, 120000); // Refresh every 2 min
</script>

</body>
</html>
